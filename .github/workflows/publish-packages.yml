name: Publish Packages
  
on: [push, pull_request]

jobs:
  setup:
    runs-on: ubuntu-latest
    
    outputs:
      commit-branch: ${{ steps.branch.outputs.branch }}
      commit-files: ${{ steps.files.outputs.all }}
          
    steps:
    - id: files
      name: Get Changed Files
      uses: jitterbit/get-changed-files@v1
      with:
        format: 'csv'
      
    - name: Checkout
      uses: actions/checkout@v2
    
    - id: branch
      name: Parse Branch
      run: |
        FULL_BRANCH_PATH="${{ github.ref }}"
        echo "BRANCH=${FULL_BRANCH_PATH/refs\/heads\//}" >> $GITHUB_ENV
        echo "::set-output name=branch::${{ env.BRANCH }}"
        
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
        include-prerelease: true
    
    - name: Install dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release /p:Branch=$BRANCH
    
  package-source-generators:
    name: Publish Patterns.Util.SourceGenerators
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - run: echo ${{ needs.setup.outputs.commit-branch }}
    
    - name: Publish Patterns.Util.SourceGenerators
      uses: matthewhancock/actions-patterns-publish-project@main
      with:
        project: Patterns.Util.SourceGenerators
        path-project: Patterns.Util.SourceGenerators
        nuget-apikey: ${{ secrets.NUGET }}
        env-commit-branch: ${{ needs.setup.outputs.commit-branch }}
        env-commit-files: ${{ needs.setup.outputs.commit-files }}
  
  package-mapping:
    name: Publish Patterns.Util.Mapping
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Publish Patterns.Util.Mapping
      uses: matthewhancock/actions-patterns-publish-project@main
      with:
        project: Patterns.Util.Mapping
        path-project: Patterns.Util.Mapping
        path-tests-unit: Tests\UnitTests\Patterns.Util.Mapping.UnitTests
        nuget-apikey: ${{ secrets.NUGET }}
        env-commit-branch: ${{ needs.setup.outputs.commit-branch }}
        env-commit-files: ${{ needs.setup.outputs.commit-files }}
